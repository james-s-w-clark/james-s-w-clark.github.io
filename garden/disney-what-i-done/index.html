<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;600;700;800&family=Frank+Ruhl+Libre:wght@200;300;400;500;600&family=Encode+Sans+Semi+Condensed:wght@400&display=swap" rel=stylesheet><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/all.min.css><link disabled id=dark-mode-theme rel=stylesheet href=/css/dark.css><link rel=stylesheet type=text/css href=/css/style.css><link rel=stylesheet type=text/css href=/css/my_style.css><title>James' Digital Garden | Career - Disney Streaming - What I Done</title><meta name=description content="&mldr;  because a CV is too brief"></head><body><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class=container><a class=navbar-brand href=https://james-s-w-clark.github.io><b style=font-weight:800>JC</b></a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNavDropdown aria-controls=navbarNavDropdown aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavDropdown><ul class="navbar-nav ms-auto mt-2 mt-lg-0"><li class=nav-item><a class=nav-link href=/garden/>Digital Garden</a></li><li class=nav-item><a class=nav-link href=/about/>About</a></li><li class="nav-item px-2 pt-1"><a class="btn fas fa-moon" id=dark-mode-toggle></a></li></ul></div></div></nav><div id=content><div class=container style=max-width:800px><div class="py-4 rounded-3"><div class="container-fluid py-2"><h1 class="display-2 mb-4 text-center">Career - Disney Streaming - What I Done</h1></div><p class="text-center fs-4 fst-italic serif">&mldr; because a CV is too brief</p><div class="text-center pt-4"></div></div><div class="row justify-content-center mb-5"><div class=col-12><p class="card-date m-0">Created Jun 6, 2023 -
Last updated: Jun 6, 2023</p><hr class=dropdown-divider><div class="row justify-content-between"><div class=col-sm-4><span class=status>Seeding üå±</span></div><div class=col-sm-8 style=text-align:right><span class="badge tag-badge">work, tech</span></div></div></div></div><div class="container-fluid py-2"><div class="serif main-content"><p>Outside of usual sprint project work (Scala Functional Programming microservices), I enjoyed dabbling with different bits of tech and ideas (mostly tech/way of working related) in my time at Disney Streaming so far!</p><h1 id=migrating-our-team-to-kubernetes>Migrating our team to Kubernetes</h1><p>We were running our applications on a bespoke ECS-like platform - which worked fairly well, apart from deployments regularly failing due to nodes being too small to fit pods onto. It has health checks, self-healing properties, etc. like Kubernetes - but you can&rsquo;t easily <code>ssh</code> into pods even in non-prod environments easily. There&rsquo;s more reasons for the move, but basically there&rsquo;s a company-wide effort to move to EKS.</p><p>I loved using Kubernetes (with k9s!) at Sainsbury&rsquo;s, so I volunteered to lead this migration project for our team. Here&rsquo;s some things I learned whilst leading this:</p><ul><li><p>A shared knowledge base such as Google Docs works great. We captured key meeting notes, decisions, diagrams, etc. here.</p><ul><li>Anyone can get up to speed quickly</li><li>Easy to ask questions, add comments</li></ul></li><li><p>Creating a &ldquo;team training Slack channel&rdquo; for a new tech domain works great</p><ul><li>As you work through the training, questions, problems, and solutions crystallise</li><li>All information is contained neatly in the channel, not spread all over various places<ul><li>It&rsquo;s easier to collate key points and give feedback to the course owners</li></ul></li><li>You can expand the channel beyond just your team, sharing the benefits</li></ul></li><li><p>For real-time knowledge sharing, encourage various people to take tickets on the work. Pair with them for smooth KT</p></li><li><p>In refinement, it can be great to call out a ticket as a pairing ticket - a &ldquo;üçê&rdquo; emoji in the title is a nice reminder that some felt they had something new to learn from it</p></li></ul><p>I also wrote a popular internal blog post for our organisation about how to use <a href=https://k9scli.io/><code>k9s</code></a>, with specific instructions for a frictionless walk-through.</p><h1 id=ci-jenkins>CI (Jenkins)</h1><ul><li>Consider adding a &ldquo;notes&rdquo; text parameter to some builds. Even if you don&rsquo;t update the build description with this, it can be very useful to know why some builds were run (e.g. manual perf testing of a branch - what change, what is expected)</li><li>For performance tests, put time-stamped links to observability platforms (DataDog, Grafana, etc.) in the output - it really helps the ergonomics of diagnosing any issues. Lower barrier to entry helps keep performance high!</li><li>Be mindful of how many messages you&rsquo;re sending to Slack, and where. If there&rsquo;s just a little traffic, it can go to a visible team chat. If it&rsquo;s noisy, it&rsquo;ll probably go to a chat where people don&rsquo;t look as often!</li><li>For parameters, be explicit - say <code>3600</code> for the <code>default</code> seconds run time, rather than <code>default</code> then loading in the number based on that string</li></ul><h1 id=ci-github-actions>CI (GitHub Actions)</h1><p>Apart from linting, auto-fixing, formatting, etc. there are some really cool things you can do with GHA and GH</p><ul><li><p>Have a fairly complex/tedious workflow for e.g. building docker images and performance testing them on a branch? Use ChatOps to listen to a command and let an Action do it for you</p><ul><li>It can reply with a comment, linking to the builds, perf tests, dashboards, etc.</li><li>It can describe what process it is doing, for more explicit documentation</li></ul></li><li><p>Use Chinthakagodawita&rsquo;s <a href=https://github.com/chinthakagodawita/autoupdate>autoupdate</a> action to keep PR&rsquo;s up-to-date with the <code>main</code> branch</p><ul><li>If you have <code>auto merge</code> enabled, you can use the <code>PR_FILTER</code> of <code>auto_merge</code><ul><li>Done reviewing 5 PRs? Hit auto merge on them, and this will keep them merging until they&rsquo;re all done!</li><li>Without this, you&rsquo;d have to wait and press &ldquo;merge from main&rdquo; four times. That could be like 10-30 minutes being distracted!</li></ul></li></ul></li></ul><p>Open source contributions:</p><ul><li>Coursier&rsquo;s <code>setup-action</code> is &ldquo;A GitHub Action to install Coursier and use it to install Java and Scala CLI tools.&rdquo;. It can set up various Java verisons and distributions.<ul><li>We use Amazon Corretto at work, and AWS. I [added Corretto to the jvm-index repo](<a href=https://github.com/coursier/setup-action>https://github.com/coursier/setup-action</a> <a href=https://github.com/coursier/jvm-index/blob/master/src/Corretto.scala)>https://github.com/coursier/jvm-index/blob/master/src/Corretto.scala)</a>.</li></ul></li></ul><h1 id=docusaurus>Docusaurus</h1><p>I was familiar with Hugo&rsquo;s Doks static site generator, and was happy to try a new SSG here: Docusaurus.</p><p>We were on Docusaurus 1, and we had a lot of complexity with the sidebar, document ordering, couldn&rsquo;t use cool new plugins, etc. - so I was happy to simplify things and upgrade us to Docusuaurs 2. Here&rsquo;s a few tips:</p><ul><li>Set up <a href=https://github.com/marketplace/actions/deploy-pr-preview>PR preview</a>, so non-developers can see what their changes look like<ul><li>You might need to &ldquo;recreate&rdquo; the Action from scratch to avoid nesting (it&rsquo;s a composite action) - see <a href=https://github.com/rossjrw/pr-preview-action/issues/33>this issue</a></li></ul></li><li>Consider adding comments to your site, so people can reach out with the context directly above. <a href=https://utteranc.es/>utteranc.es</a> can help with this</li><li>Add light/dark src/css/custom.css to match the rest of your project&rsquo;s branding</li><li>For user-facing documentation, add a FAQ page. This could save a lot of time helping resolve confusion on your most common questions!</li><li>When choosing document order, set weights like 0, 10, and 20. If you set 0, 1, and 2 then you can&rsquo;t insert a document between any of them without changing many files. With the former setup, you can set &ldquo;15&rdquo; to get between 10 and 20.</li></ul><h2 id=text-search-in-docusaurus>Text search in Docusaurus</h2><p>I also added text search, to help our users navigate straight to what their looking for - without having to look through the structure of our sidebar. I did this as a spike for fun on a &ldquo;learning Friday&rdquo; - and when it was nearly ready, our users were excited for it - it was apparently quite a headache for them. Once I figured it out, it was really simple! I <a href=https://github.com/cmfcmf/docusaurus-search-local/commit/f169f9acc9fd44d7963f6e732466ba6cd38e6ce9>raised documentation</a> for this to make it easier for other people to get up to speed quickly with it too.</p><p>package.json adds e.g.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#d88200>&#34;dependencies&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;@cmfcmf/docusaurus-search-local&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;^0.11.0&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>docusaurus.config.js adds e.g.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75af00>plugins</span><span style=color:#f92672>:</span> <span style=color:#111>[</span><span style=color:#75af00>require</span><span style=color:#111>.</span><span style=color:#75af00>resolve</span><span style=color:#111>(</span><span style=color:#d88200>&#34;@cmfcmf/docusaurus-search-local&#34;</span><span style=color:#111>)],</span>
</span></span></code></pre></div><p>To see it locally, do <code>yarn build</code> and <code>yarn serve</code>. These make a production-like version of your site. <code>yarn run dev</code> does not integrate most of the search plugins (the search index is built on build only)</p><p>There&rsquo;s also <a href=https://github.com/easyops-cn/docusaurus-search-local>https://github.com/easyops-cn/docusaurus-search-local</a> if you need it to be local/static.
Algolia is popular, but it needs a server.
See more <a href=https://docusaurus.io/docs/search>in the Docusaurus docs</a></p><h1 id=meetings>Meetings</h1><ul><li>Enable closed captions<ul><li>Having the auto-generated subtitles should be accurate enough to help some of your team follow the conversation</li><li>If the auto-generated subtitles are garbage, you probably need to spend some budget on upgrading microphones. If the computer can&rsquo;t understand you, maybe humans are having an issue too!</li></ul></li></ul><h1 id=calendar>Calendar</h1><ul><li>If a meeting is recorded, but a link to the recording in the invite. It gives a real home to the recording, rather than just a Slack message that gets lost. Helpful for people coming back from holiday/sickness - can flick through Calendar and get straight into the meetings they need to catch up on</li></ul><h1 id=build-caching>Build caching</h1><p>Compiling your apps from scratch every time is a waste of time & energy.
Some build tools support delta/partial compilation - if only 1 file in 1000 changed, we can base our compile around that.
GitHub Actions has a few options for caching dependencies, e.g. <a href=https://github.com/actions/cache>https://github.com/actions/cache</a> or <a href=https://github.com/coursier/cache-action>https://github.com/coursier/cache-action</a>. That <em>could</em> help a little.
Some build tools have a remote cache - that&rsquo;s great for quicker builds on CI. But, if you don&rsquo;t have a remote cache - what can you do?</p><p>Our team uses our own <code>mill</code> build tool container. It already ran some basic checks to check it&rsquo;d work with our project and could initialise some &ldquo;workers&rdquo; - but didn&rsquo;t do any caching. Here&rsquo;s what I did:</p><ul><li>Use a wrapper <code>millw</code>, a bit like <code>gradlew</code>. This would allow the container to build for any <code>.mill-version</code>, by downloading the necessary tooling<ul><li>If we merge a build tool upgrade in our main repo, builds would still work without requiring a manual rebuild on the new version of this image. Not technically efficient due to the redownloads of the build tool, but ultimately removing some toil in making things a little smoother for humans.</li><li>Compile, check formatting, fixing, etc. to generate these outputs in <code>out</code>, as well as downloading dependencies</li><li>To prevent being over-written, run <code>mv /root/build/out /root/out-cache</code>. In Jenkins jobs for app builds, move this cache back (if the build is parameterised with using the cache). Dependencies cache doesn&rsquo;t need moving.</li><li>The cache doesn&rsquo;t have to be used. It adds some size, but storage is cheap and saved time/energy is valuable. We use it for PR builds (not <code>main</code> - that&rsquo;s clean), and</li></ul></li></ul><p>The outcome of this is that, several minutes are shaved off each module (more or less, each microservice) build time. <em>Faster PR compilations means faster PR checks, which means delivering value faster and reducing our mean time to recovery.</em> It also means faster builds for ChatOps triggering branch builds + perf tests, giving fast feedback on performance critical code changes!</p><figure><img src=build-cache.webp alt="Can you guess which builds are using the cache?" width=100%><figcaption><p>Can you guess which builds are using the cache?</p></figcaption></figure><p>I was pleased with doing this, as using <code>deltas</code> like this has seemed awesome to me for a long time. I was amazed as a teenager when one Android custom ROM could deliver OTA updates 10x smaller than anyone else, by using deltas.</p><h1 id=performance-tests>Performance tests</h1><p>In your performance testing platform (we use Gatling), consider what types of test you want to have, and what should be compared:</p><ul><li>nightly, load (main)<ul><li>I made them run for longer (why not? nobody is manually testing on the <code>perf</code> env at 3am)</li><li>I made them run at peak RPS for 75% of the run time (configurable). Previously, only about 20% of the time was at peak RPS. Choose a traffic shape gives your services a proper workout!</li></ul></li><li>soak (main)<ul><li>Have seen dependencies clash and lead to slow memory leaks; soak tests protect us from this, run over the weekend</li><li>I oversaw various performance test changes around this time after identifying improvements with the team in a post-mortem.</li><li>Here, we basically decrease the load a little bit (75% of nightly) and run for much longer</li></ul></li><li>load (branch)<ul><li>results could be very far from average results on <code>main</code>, so have separate simulation to keep your &ldquo;usually good&rdquo; simulations clean</li></ul></li></ul><p>You can try different traffic shapes, e.g. a triangle wave over a day to simulate real traffic variety. How does your app perform as load varies?</p><p>We previously sent the reports to Slack, with pass/fail and the targets. I added time-stamped hyperlinks to observability dashboards for ergonomics.</p><h1 id=git-hooks>Git hooks</h1><p>Git hooks are great - ensure your code is linted/compilable/tested before pushing.
What&rsquo;s even cooler is combining them with interactive CLI tooling like <code>gum</code> - see my <a href=https://github.com/IdiosApps/gummy-hooks>&ldquo;gummy hooks&rdquo;</a> examples.</p><ul><li>Iterate quicker by using a bash script and just calling it - you don&rsquo;t actually have to do anything with Git to iterate on it.</li></ul><h1 id=scala-steward>Scala Steward</h1><h2 id=not-receiving-updates>Not receiving updates</h2><p>For Scala, a common tool for getting dependency upgrades (and new Scala versions!) is <a href=https://github.com/scala-steward-org/scala-steward>Scala Steward</a>.
For about half a year, only a few of our dependencies were getting updates. You may remember when Log4j had multiple security vulnerabilities (and corresponding patches) within about one week, in December 2021. This one <em>was</em> patched automatically. A few other dependencies weren&rsquo;t being updated (note: I never saw security issues, or if we did we&rsquo;d patch manually).</p><p>We were extracting a version and interpolating with it.
The fix here was to declare each dependency and its version on its own line. It didn&rsquo;t really make PRs harder to review, and is even a bit clearer in a PR to show you what really changed.</p><p>If you&rsquo;re not getting updates with Scala Steward, that might be something to look into!</p><h2 id=not-receiving-updates-20-failed-to-decode-modules>Not receiving updates&mldr; 2.0: <code>Failed to decode Modules</code></h2><p>If you have a big <code>Mill</code> Scala project (let&rsquo;s say, a monorepo - with about 10 modules) and fair number of dependencies - you might be seeing this problem.</p><p>I ran a local clone of Steward with a teammate, adding some print-lines to diagnose the parser. We saw the input string for parsing was blank for our project. Looking at <code>MillAlg.scala</code>, we saw about <a href=https://github.com/scala-steward-org/scala-steward/pull/2717>5000 lines of the <em>end</em> of a JSON object</a>. The default buffer is 8192 bytes. Increasing the CLI argument <a href=https://github.com/scala-steward-org/scala-steward/pull/1829><code>--max-buffer-size</code></a> to <code>32768</code> fixed the issue for us. The author also raised a <a href=https://github.com/scala-steward-org/scala-steward/pull/2940>PR</a> to give a more obvious error about this, instead of returning some partial JSON.</p><h1 id=kinesis>Kinesis</h1><p>With Kinesis, we were getting hundreds of thousands of errors per week -<code>[metrics_manager.cc:145] Metrics upload failed</code>- giving a very bad signal:noise ratio in our DataDog logs.</p><p>We only use metrics at the &ldquo;stream&rdquo; level, rather than the &ldquo;shard&rdquo; level (a stream has many shards, and shards can sometimes report no data & error).</p><p>On a <code>KinesisProducerConfiguration</code>, do <code>.setMetricsGranularity("stream")</code>. The default level is &ldquo;shard&rdquo;.</p><p>Also be mindful of costs. The Javadocs state that two shards with two streams each will produce <em>seven</em> CloudWatch metrics (4x shard, 2x stream, 1 global).</p><p>AWS support was not so helpful with this error (<a href=https://github.com/awslabs/amazon-kinesis-producer/issues/188#issuecomment-557198786>essentially saying: &ldquo;it&rsquo;s a known issue, but please work around it by filtering out the logs&rdquo;</a>) - setting a more accurate configuration is better, and I <a href=https://github.com/awslabs/amazon-kinesis-producer/issues/188#issuecomment-1189202115>shared our recommendation on the issue</a>.</p><h1 id=on-call>On-call</h1><p>With good tests (unit, integration, end-to-end, performance, etc.), you won&rsquo;t get called out much and it might be worth the extra pay bump + other perks :)</p><h1 id=gh-cli---downloading-files--using-in-github-actions><code>gh</code> CLI - downloading files, & using in GitHub Actions</h1><p><code>curl $(gh api $URL_TO_FILE_ON_GITHUB) --jq .download_url) -o ./path/to/download.ext</code></p><p>If you install the <code>gh</code> CLI on you GitHub Action runners too, it can be a nice way to interact with your GitHub (enterprise works too!). You just need to <a href=https://josh-ops.com/posts/gh-auth-login-in-actions/>set the enterprise token and GitHub Host as env variables</a>.</p></div></div></div></div><div class=container><div class="row justify-content-between"><div class=col-sm-4><p class=footer>James Clark ¬© 2024</p></div><div class="col-sm-6 d-flex flex-row-reverse"><a class="footer-social px-2" href=https://raw.githubusercontent.com/IdiosApps/IdiosApps.github.io/gh-pages/index.xml target=_blank><i class="fas fa-rss"></i></a>
<a class="footer-social px-2" href=https://github.com/IdiosApps target=_blank><i class="fab fa-github"></i></a>
<a class="footer-social px-2" href=https://medium.com/@james.sw.clark target=_blank><i class="fab fa-medium-m"></i></a>
<a class="footer-social px-2" href=https://www.linkedin.com/in/james-sw-clark/ target=_blank><i class="fab fa-linkedin-in"></i></a></div></div></div><script src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/jquery.min.js></script>
<script src=/js/isotope.pkgd.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity=sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D crossorigin=anonymous async></script>
<script src=/js/dark.js></script>
<script src=/js/isotope.js></script>
<script src=/js/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script></body></html>